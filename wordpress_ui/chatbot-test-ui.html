<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Franchise Chatbot - Intelligent Flow</title>
    <style>
        /* Scoped chatbot styles - won't affect page layout */
        #pgpt-chatbot-container {
            all: initial;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999999;
            font-family: "Calibri", "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
        }

        #pgpt-chatbot-container * {
            box-sizing: border-box;
        }

        #pgpt-chatbot-container .chatbot-wrapper {
            width: 380px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            height: 600px;
            max-height: calc(100vh - 40px);
            overflow: hidden;
            font-family: "Calibri", "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
        }

        /* Header */
        #pgpt-chatbot-container .pgpt-chat-header {
            background: #ffffff;
            color: #333;
            padding: 16px;
            border-radius: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #pgpt-chatbot-container .pgpt-header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #pgpt-chatbot-container .pgpt-bot-icon-container {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .pgpt-bot-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .pgpt-bot-icon-fallback {
            font-size: 32px;
            display: none;
        }

        .pgpt-chat-header h3 {
            font-size: 16px;
            margin: 0;
            color: #333;
        }

        .pgpt-status {
            font-size: 12px;
            opacity: 0.7;
            color: #666;
        }

        .pgpt-close-chatbot-btn {
            background: transparent;
            border: none;
            color: #666;
            font-size: 20px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            margin-left: auto;
        }

        .pgpt-close-chatbot-btn:hover {
            background: rgba(0, 0, 0, 0.08);
            color: #333;
        }

        /* AI Disclaimer Banner */
        .pgpt-disclaimer-banner {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 14px 16px;
            margin: 20px 20px 16px 20px;
            animation: pgpt-slide-down 0.3s ease;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
        }

        .pgpt-disclaimer-banner.pgpt-hidden {
            display: none;
        }

        @keyframes pgpt-slide-down {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pgpt-disclaimer-banner-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .pgpt-disclaimer-icon-container {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }

        .pgpt-disclaimer-icon {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .pgpt-disclaimer-icon-fallback {
            font-size: 20px;
            display: none;
        }

        .pgpt-disclaimer-text {
            flex: 1;
            font-size: 13px;
            line-height: 1.5;
            color: #92400e;
        }

        .pgpt-disclaimer-text strong {
            color: #78350f;
        }

        .pgpt-close-disclaimer-btn {
            background: transparent;
            border: none;
            color: #92400e;
            font-size: 18px;
            cursor: pointer;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            transition: background 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .pgpt-close-disclaimer-btn:hover {
            background: rgba(146, 64, 14, 0.1);
        }

        /* Messages Area */
        #pgpt-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f7f7f7;
            scroll-behavior: smooth;
        }

        #pgpt-chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        #pgpt-chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #pgpt-chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .pgpt-message {
            display: flex;
            gap: 14px;
            margin-bottom: 20px;
            animation: pgpt-message-fade-in 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pgpt-message:last-child {
            margin-bottom: 0;
        }

        @keyframes pgpt-message-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pgpt-assistant-message {
            flex-direction: row;
        }

        .pgpt-user-message {
            flex-direction: row-reverse;
        }

        .pgpt-avatar {
            width: 32px;
            height: 32px;
            font-size: 24px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .pgpt-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .pgpt-avatar-fallback {
            font-size: 24px;
            display: none;
        }

        .pgpt-bubble {
            background: #ffffff;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 75%;
            line-height: 1.5;
            color: #333;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .pgpt-bubble p,
        .pgpt-bubble div {
            margin: 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .pgpt-bubble div {
            margin-bottom: 8px;
        }

        .pgpt-bubble div:last-child {
            margin-bottom: 0;
        }

        .pgpt-user-message .pgpt-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Quick Reply Buttons */
        .pgpt-quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .pgpt-quick-btn {
            background: #ffffff;
            border: 1px solid #667eea;
            color: #667eea;
            border-radius: 18px;
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            font-weight: 500;
            font-family: inherit;
        }

        .pgpt-quick-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .pgpt-quick-btn:active {
            transform: translateY(0);
        }

        /* Carousel/Cards */
        .pgpt-carousel {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 4px;
            margin-top: 12px;
            padding-bottom: 12px;
            scrollbar-width: thin;
        }

        .pgpt-carousel::-webkit-scrollbar {
            height: 4px;
        }

        .pgpt-carousel::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .pgpt-carousel::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .pgpt-card {
            min-width: 240px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 14px;
            flex-shrink: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .pgpt-card h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #1f2937;
            font-weight: 600;
        }

        .pgpt-card-stat {
            font-size: 13px;
            color: #555;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pgpt-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .pgpt-card-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: all 0.2s;
            font-family: inherit;
        }

        .pgpt-card-btn.btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .pgpt-card-btn.btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .pgpt-card-btn.btn-outline {
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
        }

        .pgpt-card-btn.btn-outline:hover {
            background: #f0f0f0;
        }

        /* Typing Indicator */
        #pgpt-typing-indicator {
            display: flex;
            gap: 8px;
            padding: 0 20px 10px;
            background: #f9fafb;
        }

        #pgpt-typing-indicator.pgpt-hidden {
            display: none;
        }

        .pgpt-typing-dots {
            background: #e5e7eb;
            padding: 10px 14px;
            border-radius: 12px;
            display: flex;
            gap: 4px;
        }

        .pgpt-typing-dots span {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: pgpt-bounce 1.4s infinite;
        }

        .pgpt-typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .pgpt-typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pgpt-bounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Input Area */
        .pgpt-chat-input-area {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
            align-items: center;
            background: #ffffff;
        }

        .pgpt-message-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            color: #1f2937;
            font-family: inherit;
        }

        .pgpt-message-input::placeholder {
            color: #9ca3af;
        }

        .pgpt-message-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .pgpt-send-button {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
            outline: none;
        }

        .pgpt-send-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .pgpt-send-button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .pgpt-send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .pgpt-send-button svg {
            width: 20px;
            height: 20px;
        }

        /* WhatsApp Widget */
        .pgpt-whatsapp-widget {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
        }

        .pgpt-whatsapp-widget:hover {
            background: linear-gradient(135deg, #20ba5a 0%, #1da851 100%);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        }

        .pgpt-whatsapp-widget:active {
            transform: scale(0.95);
        }

        .pgpt-whatsapp-widget svg {
            width: 20px;
            height: 20px;
        }

        /* Calendly Modal */
        .pgpt-calendly-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000000;
            animation: pgpt-fade-in 0.3s ease;
        }

        .pgpt-calendly-overlay.pgpt-hidden {
            display: none !important;
        }

        @keyframes pgpt-fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .pgpt-calendly-modal {
            background: #ffffff;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: pgpt-scale-in 0.3s ease;
        }

        @keyframes pgpt-scale-in {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .pgpt-calendly-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
            border-radius: 16px 16px 0 0;
        }

        .pgpt-calendly-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }

        .pgpt-close-calendly {
            background: transparent;
            border: none;
            color: #333;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .pgpt-close-calendly:hover {
            background: rgba(0, 0, 0, 0.08);
        }


        .pgpt-calendly-content {
            padding: 0;
            overflow: hidden;
            flex: 1;
            min-height: 600px;
        }

        .pgpt-calendly-inline-widget {
            width: 100%;
            height: 600px;
            min-height: 600px;
        }

        .pgpt-hidden {
            display: none !important;
        }

        /* Pre-Chat Sign-In Form (Inline in Chat) - Scoped to chatbot only */
        #pgpt-chat-messages .pgpt-prechat-form {
            background: #ffffff !important;
            border-radius: 12px !important;
            padding: 20px !important;
            margin: 20px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            animation: pgpt-message-fade-in 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            font-family: "Calibri", "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif !important;
            box-sizing: border-box !important;
            position: relative !important;
            z-index: 1 !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form.pgpt-hidden {
            display: none !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form h3 {
            margin: 0 0 16px 0 !important;
            font-size: 18px !important;
            color: #333 !important;
            text-align: center !important;
            font-weight: 600 !important;
            line-height: 1.4 !important;
            padding: 0 !important;
            border: none !important;
            background: transparent !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-prechat-input {
            width: 100% !important;
            padding: 12px 16px !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            margin-bottom: 12px !important;
            transition: border-color 0.2s !important;
            box-sizing: border-box !important;
            font-family: "Calibri", "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif !important;
            background: #ffffff !important;
            color: #333 !important;
            line-height: normal !important;
            height: auto !important;
            min-height: auto !important;
            max-height: none !important;
            display: block !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-prechat-input:focus {
            outline: none !important;
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-prechat-button {
            width: 100% !important;
            padding: 14px !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
            border-radius: 12px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: transform 0.2s, box-shadow 0.2s !important;
            margin-top: 8px !important;
            font-family: "Calibri", "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif !important;
            line-height: normal !important;
            text-align: center !important;
            text-decoration: none !important;
            display: block !important;
            box-sizing: border-box !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-prechat-button:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3) !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-prechat-button:active {
            transform: translateY(0) !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-prechat-consent {
            font-size: 11px !important;
            color: #666 !important;
            text-align: center !important;
            margin-top: 12px !important;
            line-height: 1.4 !important;
            padding: 0 !important;
            font-family: "Calibri", "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif !important;
            background: transparent !important;
            border: none !important;
        }

        /* Pre-chat choice buttons */
        #pgpt-chat-messages .pgpt-prechat-form .pgpt-choice-buttons {
            display: flex !important;
            flex-direction: column !important;
            gap: 12px !important;
            margin-top: 8px !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-choice-btn {
            width: 100% !important;
            padding: 14px !important;
            border: 2px solid #667eea !important;
            border-radius: 12px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.2s !important;
            font-family: "Calibri", "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif !important;
            line-height: normal !important;
            text-align: center !important;
            background: white !important;
            color: #667eea !important;
            box-sizing: border-box !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-choice-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border-color: transparent !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-choice-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3) !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-choice-btn:active {
            transform: translateY(0) !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-form-fields {
            display: none !important;
        }

        #pgpt-chat-messages .pgpt-prechat-form .pgpt-form-fields.active {
            display: block !important;
        }

        /* Feedback UI - Scoped to chatbot only */
        #pgpt-chatbot-container .pgpt-feedback-overlay {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 10000 !important;
            animation: pgpt-fade-in 0.3s ease !important;
        }

        #pgpt-chatbot-container .pgpt-feedback-overlay.pgpt-hidden {
            display: none !important;
        }

        #pgpt-chatbot-container .pgpt-feedback-box {
            background: white !important;
            border-radius: 16px !important;
            padding: 30px !important;
            max-width: 320px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2) !important;
            text-align: center !important;
            animation: pgpt-scale-in 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        #pgpt-chatbot-container .pgpt-feedback-box h3 {
            margin: 0 0 20px 0 !important;
            font-size: 20px !important;
            color: #333 !important;
            font-weight: 600 !important;
        }

        #pgpt-chatbot-container .pgpt-feedback-buttons {
            display: flex !important;
            gap: 20px !important;
            justify-content: center !important;
        }

        #pgpt-chatbot-container .pgpt-feedback-btn {
            background: none !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 50% !important;
            width: 70px !important;
            height: 70px !important;
            font-size: 32px !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        #pgpt-chatbot-container .pgpt-feedback-btn:hover {
            transform: scale(1.1) !important;
            border-color: #667eea !important;
        }

        #pgpt-chatbot-container .pgpt-feedback-btn.thumbs-up:hover {
            background: #e8f5e9 !important;
        }

        #pgpt-chatbot-container .pgpt-feedback-btn.thumbs-down:hover {
            background: #ffebee !important;
        }

        @keyframes pgpt-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pgpt-scale-in {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Chat Bubble Button */
        #pgpt-chat-bubble {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999998;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: pgpt-bubble-bounce 2s infinite;
        }

        #pgpt-chat-bubble.pgpt-hidden {
            display: none !important;
        }

        #pgpt-chat-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.5);
        }

        #pgpt-chat-bubble svg {
            width: 30px;
            height: 30px;
            color: white;
        }

        @keyframes pgpt-bubble-bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        #pgpt-chat-bubble:hover {
            animation: none;
        }

        /* Hide chatbot container when collapsed */
        #pgpt-chatbot-container.pgpt-collapsed {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 480px) {
            #pgpt-chatbot-container {
                bottom: 0;
                right: 0;
                left: 0;
                top: 0;
            }
            
            #pgpt-chatbot-container .chatbot-wrapper {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            #pgpt-chat-bubble {
                width: 56px;
                height: 56px;
                bottom: 16px;
                right: 16px;
            }

            #pgpt-chat-bubble svg {
                width: 28px;
                height: 28px;
            }
        }
    </style>
</head>
<body>
    <!-- Chat Bubble Button -->
    <div id="pgpt-chat-bubble">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
        </svg>
    </div>

    <!-- Chatbot Container -->
    <div id="pgpt-chatbot-container" class="pgpt-collapsed">
        <div class="chatbot-wrapper">
        <!-- Header -->
        <div class="pgpt-chat-header">
            <div class="pgpt-header-content">
                <div class="pgpt-bot-icon-container">
                    <img src="https://staging2.franquiciaboost.com/wp-content/uploads/2023/11/cropped-IconOnly_Transparent-2.png" alt="Franquicia Boost Logo" class="pgpt-bot-icon" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="pgpt-bot-icon-fallback" style="display: none;">ü§ñ</span>
                </div>
                <div>
                    <h3>AI Assistant</h3>
                    <span class="pgpt-status">‚óè Online</span>
                </div>
            </div>
            <button id="pgpt-close-chatbot" class="pgpt-close-chatbot-btn" aria-label="Close chatbot">‚úï</button>
        </div>

        <!-- Chat Messages Area -->
        <div id="pgpt-chat-messages">
            <!-- Pre-Chat Sign-In Form -->
            <div id="pgpt-prechat-form" class="pgpt-prechat-form">
                <h3>üëã Welcome!</h3>
                
                <!-- Choice Buttons -->
                <div id="pgpt-choice-screen" class="pgpt-choice-buttons">
                    <button id="pgpt-signin-btn" class="pgpt-choice-btn primary">
                        üîê Sign In
                    </button>
                    <button id="pgpt-guest-btn" class="pgpt-choice-btn">
                        üë§ Continue as Guest
                    </button>
                </div>

                <!-- Sign-In Form (hidden initially) -->
                <div id="pgpt-signin-form" class="pgpt-form-fields">
                    <input id="pgpt-user-name" placeholder="Full Name" class="pgpt-prechat-input" required />
                    <input id="pgpt-user-email" type="email" placeholder="Email Address" class="pgpt-prechat-input" required />
                    <input id="pgpt-user-phone" type="tel" placeholder="Phone Number" class="pgpt-prechat-input" required />

                    <button id="pgpt-start-chat" class="pgpt-prechat-button">
                        Start Chat
                    </button>

                    <div class="pgpt-prechat-consent">
                        By starting this chat, you agree to data collection for communication purposes.
                    </div>
                </div>
            </div>

            <!-- AI Disclaimer Banner -->
            <div id="pgpt-disclaimer-banner" class="pgpt-disclaimer-banner">
                <div class="pgpt-disclaimer-banner-content">
                    <div class="pgpt-disclaimer-icon-container">
                        <img src="https://staging2.franquiciaboost.com/wp-content/uploads/2023/11/cropped-IconOnly_Transparent-2.png" alt="Franquicia Boost" class="pgpt-disclaimer-icon" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <span class="pgpt-disclaimer-icon-fallback" style="display: none;">ü§ñ</span>
                    </div>
                    <div class="pgpt-disclaimer-text">
                        <strong>AI Chatbot Notice:</strong> This is an AI-powered assistant. While we strive for accuracy, the AI may occasionally make mistakes. Please verify important information.
                    </div>
                    <button id="pgpt-close-disclaimer" class="pgpt-close-disclaimer-btn">‚úï</button>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="pgpt-typing-indicator" class="pgpt-typing-indicator pgpt-hidden">
            <div class="pgpt-avatar">
                <img src="https://staging2.franquiciaboost.com/wp-content/uploads/2023/11/cropped-IconOnly_Transparent-2.png" alt="Franquicia Boost" class="pgpt-avatar-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span class="pgpt-avatar-fallback" style="display: none;">ü§ñ</span>
            </div>
            <div class="pgpt-typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="pgpt-chat-input-area">
            <a id="pgpt-whatsapp-widget" class="pgpt-whatsapp-widget" href="#" target="_blank" rel="noopener noreferrer" title="Chat on WhatsApp">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
            </a>
            <input 
                type="text" 
                id="pgpt-message-input" 
                class="pgpt-message-input" 
                placeholder="Type your message..."
                autocomplete="off"
            />
            <button id="pgpt-send-button" class="pgpt-send-button" aria-label="Send message">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
                </svg>
            </button>
        </div>

        <!-- Feedback Overlay -->
        <div id="pgpt-feedback-overlay" class="pgpt-feedback-overlay pgpt-hidden">
            <div class="pgpt-feedback-box">
                <h3>How was your experience?</h3>
                <div class="pgpt-feedback-buttons">
                    <button class="pgpt-feedback-btn thumbs-up" data-feedback="Good" title="Good Experience">
                        üëç
                    </button>
                    <button class="pgpt-feedback-btn thumbs-down" data-feedback="Bad" title="Bad Experience">
                        üëé
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Calendly Modal Overlay -->
    <div id="pgpt-calendly-overlay" class="pgpt-calendly-overlay pgpt-hidden">
        <div class="pgpt-calendly-modal">
            <div class="pgpt-calendly-header">
                <h3>üìÖ Schedule a Meeting</h3>
                <button id="pgpt-close-calendly" class="pgpt-close-calendly">‚úï</button>
            </div>
            <div class="pgpt-calendly-content">
                <div id="pgpt-calendly-inline-widget" class="pgpt-calendly-inline-widget"></div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        
        // ============================================
        // CONFIGURATION
        // ============================================
        const API_URL = 'https://fqbbot.com/v1/chat/completions';
        const CONTACT_EMAIL = 'info@franquiciaboost.com';
        const CALENDLY_URL = 'https://calendly.com/franquiciaboost';
        const WHATSAPP_NUMBER = '13683999999';
        const WHATSAPP_MESSAGE = 'Hello! I\'d like to learn more about Franquicia Boost.';
        const SYSTEM_PROMPT = 'You are an AI assistant for Franquicia Boost that MUST ONLY answer questions using information from the provided context/documents. You MUST NOT use any information from your training data or general knowledge. If the answer is not in the provided context, you MUST respond with: "I don\'t have that information in my knowledge base. For more details, please contact the Franquicia Boost team directly - you can schedule a meeting with us or drop us an email. We\'d be happy to assist you further!" Do NOT make up, guess, or infer information that is not explicitly stated in the context.';
        const MODEL_NAME = 'gpt-3.5-turbo';
        const FRANCHISE_NAME = 'Franquicia Boost';
        
        // ============================================
        // DOM ELEMENTS
        // ============================================
        const chatContainer = document.getElementById('pgpt-chat-messages');
        const inputField = document.getElementById('pgpt-message-input');
        const sendButton = document.getElementById('pgpt-send-button');
        const typingIndicator = document.getElementById('pgpt-typing-indicator');
        const calendlyOverlay = document.getElementById('pgpt-calendly-overlay');
        const closeCalendlyBtn = document.getElementById('pgpt-close-calendly');
        const whatsappWidget = document.getElementById('pgpt-whatsapp-widget');
        const disclaimerBanner = document.getElementById('pgpt-disclaimer-banner');
        const closeDisclaimer = document.getElementById('pgpt-close-disclaimer');
        const closeChatbotBtn = document.getElementById('pgpt-close-chatbot');
        
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let userProfile = null;  // User sign-in info (name, email, phone, lead_id)
        let chatEnabled = false; // Block chat until user signs in
        let flowState = 'INIT'; // INIT, BANT_EXPERIENCE, BANT_TIMELINE, BANT_CAPITAL, BANT_AUTHORITY, BANT_NEED, QUALIFIED, NURTURE, OPEN_CHAT
        let leadProfile = {
            industry: '',
            budget: '',
            timeline: '',
            capital: '',
            authority: '',
            attraction: '', // User's response to attraction question
            leadScore: 0
        };
        let conversationHistory = [];
        let isLoading = false;
        let securityNonce = null;
        let nonceTimestamp = null;
        
        // ============================================
        // SECURITY FUNCTIONS
        // ============================================
        async function getSecurityNonce() {
            try {
                const response = await fetch('/wp-json/pgpt/v1/nonce');
                const data = await response.json();
                if (data.success) {
                    securityNonce = data.nonce;
                    nonceTimestamp = data.timestamp;
                }
            } catch (error) {
                console.error('Failed to get security nonce:', error);
            }
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        window.onload = function() {
            // Disable chat input until user signs in
            inputField.disabled = true;
            sendButton.disabled = true;
            inputField.placeholder = "Please sign in first to start chatting...";
            
            // Get security nonce
            getSecurityNonce();
            
            // Refresh nonce every 4 minutes (before 5-minute expiry)
            setInterval(getSecurityNonce, 240000);
        };
        
        // ============================================
        // CORE MESSAGING FUNCTIONS
        // ============================================
        function addBotMessage(text, quickReplies = null, carouselData = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'pgpt-message pgpt-assistant-message';
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'pgpt-avatar';
            avatar.innerHTML = '<img src="https://staging2.franquiciaboost.com/wp-content/uploads/2023/11/cropped-IconOnly_Transparent-2.png" alt="Franquicia Boost" class="pgpt-avatar-img" onerror="this.onerror=null; this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\';"><span class="pgpt-avatar-fallback" style="display: none;">ü§ñ</span>';
            
            // Bubble
            const bubble = document.createElement('div');
            bubble.className = 'pgpt-bubble';
            const textP = document.createElement('p');
            textP.innerHTML = text;
            bubble.appendChild(textP);

            // Quick Reply Buttons
            if (quickReplies && quickReplies.length > 0) {
                const btnContainer = document.createElement('div');
                btnContainer.className = 'pgpt-quick-replies';
                quickReplies.forEach(qr => {
                    const btn = document.createElement('button');
                    btn.className = 'pgpt-quick-btn';
                    btn.textContent = qr.text;
                    btn.onclick = () => handleQuickReply(qr.text, qr.action);
                    btnContainer.appendChild(btn);
                });
                bubble.appendChild(btnContainer);
            }

            // Carousel (Rich Cards)
            if (carouselData && carouselData.length > 0) {
                const carousel = document.createElement('div');
                carousel.className = 'pgpt-carousel';
                carouselData.forEach(card => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'pgpt-card';
                    cardDiv.innerHTML = `
                        <h4>${escapeHtml(card.title)}</h4>
                        <div class="pgpt-card-stat">üí∞ ${escapeHtml(card.investment)}</div>
                        <div class="pgpt-card-stat">üìç ${escapeHtml(card.location)}</div>
                        ${card.rating ? `<div class="pgpt-card-stat">‚≠ê ${escapeHtml(card.rating)}</div>` : ''}
                        <div class="pgpt-card-actions">
                            <button class="pgpt-card-btn btn-primary" data-action="QUALIFICATION_START" data-value="${escapeHtml(card.title)}">Learn More</button>
                            <button class="pgpt-card-btn btn-outline" data-action="COMPARE" data-value="${escapeHtml(card.title)}">Compare</button>
                        </div>
                    `;
                    
                    // Add event listeners to card buttons
                    const cardBtns = cardDiv.querySelectorAll('.pgpt-card-btn');
                    cardBtns.forEach(btn => {
                        btn.onclick = () => {
                            const action = btn.getAttribute('data-action');
                            const value = btn.getAttribute('data-value');
                            handleQuickReply(`I'm interested in ${value}`, action, value);
                        };
                    });
                    
                    carousel.appendChild(cardDiv);
                });
                bubble.appendChild(carousel);
            }

            msgDiv.appendChild(avatar);
            msgDiv.appendChild(bubble);
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
            
            conversationHistory.push({ role: "assistant", content: text });
        }

        function addUserMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'pgpt-message pgpt-user-message';
            msgDiv.innerHTML = `
                <div class="pgpt-avatar">
                    <span class="pgpt-avatar-fallback">üë§</span>
                </div>
                <div class="pgpt-bubble">${escapeHtml(text)}</div>
            `;
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
            conversationHistory.push({ role: "user", content: text });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // FLOW ENGINE (State Machine)
        // ============================================
        window.handleQuickReply = function(text, action, value = null) {
            addUserMessage(text);
            processFlow(action, value || text);
        };

        function processFlow(action, value) {
            showTyping();
            
            setTimeout(() => {
                hideTyping();

                // --- BANT QUALIFICATION FLOW (Stage 2) ---
                if (action === "BANT_START") {
                    // Check if user is a guest - if so, collect their info first
                    if (userProfile && userProfile.lead_id.startsWith('guest_')) {
                        // Show inline form to collect guest info
                        flowState = 'GUEST_INFO_COLLECTION';
                        addBotMessage("To schedule a discovery call, I'll need a few details from you. Please provide your information below:");
                        
                        // Create inline form for guest
                        setTimeout(() => {
                            const guestFormHtml = `
                                <div class="pgpt-message pgpt-bot-message" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; border-radius: 16px !important; padding: 0 !important; margin: 10px 0 !important; max-width: 85% !important;">
                                    <div style="background: white !important; border-radius: 16px !important; padding: 20px !important; box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;">
                                        <input id="pgpt-guest-name" placeholder="Full Name" style="width: 100% !important; padding: 12px !important; margin-bottom: 12px !important; border: 2px solid #e0e0e0 !important; border-radius: 8px !important; font-size: 14px !important; font-family: 'Calibri', 'Segoe UI', sans-serif !important; box-sizing: border-box !important; transition: border-color 0.3s ease !important;" required onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'" />
                                        <input id="pgpt-guest-email" type="email" placeholder="Email Address" style="width: 100% !important; padding: 12px !important; margin-bottom: 12px !important; border: 2px solid #e0e0e0 !important; border-radius: 8px !important; font-size: 14px !important; font-family: 'Calibri', 'Segoe UI', sans-serif !important; box-sizing: border-box !important; transition: border-color 0.3s ease !important;" required onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'" />
                                        <input id="pgpt-guest-phone" type="tel" placeholder="Phone Number" style="width: 100% !important; padding: 12px !important; margin-bottom: 16px !important; border: 2px solid #e0e0e0 !important; border-radius: 8px !important; font-size: 14px !important; font-family: 'Calibri', 'Segoe UI', sans-serif !important; box-sizing: border-box !important; transition: border-color 0.3s ease !important;" required onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'" />
                                        <button id="pgpt-guest-submit" style="width: 100% !important; padding: 12px 24px !important; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; color: white !important; border: none !important; border-radius: 8px !important; font-size: 15px !important; font-weight: 600 !important; cursor: pointer !important; transition: transform 0.2s ease, box-shadow 0.2s ease !important; font-family: 'Calibri', 'Segoe UI', sans-serif !important;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            Submit & Continue
                                        </button>
                                    </div>
                                </div>
                            `;
                            chatContainer.insertAdjacentHTML('beforeend', guestFormHtml);
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                            
                            // Add event listener for guest form submission
                            document.getElementById('pgpt-guest-submit').addEventListener('click', async () => {
                                const name = document.getElementById('pgpt-guest-name').value.trim();
                                const email = document.getElementById('pgpt-guest-email').value.trim();
                                const phone = document.getElementById('pgpt-guest-phone').value.trim();
                                
                                if (!name || !email || !phone) {
                                    alert('Name, email, and phone are required');
                                    return;
                                }
                                
                                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                if (!emailRegex.test(email)) {
                                    alert('Please enter a valid email address');
                                    return;
                                }
                                
                                // Save guest info to Google Sheet
                                try {
                                    // Ensure we have a valid nonce
                                    if (!securityNonce) {
                                        await getSecurityNonce();
                                    }
                                    
                                    const res = await fetch('/wp-json/pgpt/v1/lead', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ 
                                            operation: 'CREATE',
                                            name, 
                                            email, 
                                            phone,
                                            nonce: securityNonce,
                                            timestamp: nonceTimestamp,
                                            website: '' // Honeypot field
                                        })
                                    });
                                    
                                    if (res.ok) {
                                        const data = await res.json();
                                        // Update userProfile with new lead_id from server
                                        userProfile.lead_id = data.lead_id;
                                        userProfile.name = name;
                                        userProfile.email = email;
                                        userProfile.phone = phone;
                                        
                                        // Hide the guest form
                                        const guestFormDiv = document.getElementById('pgpt-guest-submit').closest('.pgpt-bot-message');
                                        if (guestFormDiv) guestFormDiv.remove();
                                        
                                        // Now start BANT flow
                                        leadProfile = {
                                            industry: '',
                                            budget: '',
                                            timeline: '',
                                            capital: '',
                                            authority: '',
                                            attraction: '',
                                            leadScore: 0
                                        };
                                        flowState = 'BANT_EXPERIENCE';
                                        addBotMessage("Perfect! Before we schedule your call, I'd like to ask a few quick questions to make sure we maximize your time together. üòä<br><br>Have you been exploring franchise opportunities for a while, or is this fairly new?");
                                    }
                                } catch (error) {
                                    console.error('Error saving guest info:', error);
                                    alert('Unable to save your information. Please try again.');
                                }
                            });
                        }, 300);
                        return; // Exit early, wait for guest form submission
                    }
                    
                    // Regular signed-in user - start BANT flow normally
                    leadProfile = {
                        industry: '',
                        budget: '',
                        timeline: '',
                        capital: '',
                        authority: '',
                        attraction: '',
                        leadScore: 0
                    };
                    flowState = 'BANT_EXPERIENCE';
                    addBotMessage("Perfect! Before we schedule your call, I'd like to ask a few quick questions to make sure we maximize your time together. üòä<br><br>Have you been exploring franchise opportunities for a while, or is this fairly new?");
                }
                
                // --- Step 1: Experience (No points, just context) ---
                // Handled in handleInput when flowState === 'BANT_EXPERIENCE'
                
                // --- Step 2: Timeline (Score it) ---
                else if (action === "BANT_TIMELINE_3" || action === "BANT_TIMELINE_6" || action === "BANT_TIMELINE_12" || action === "BANT_TIMELINE_RESEARCH") {
                    const timelineMap = {
                        'BANT_TIMELINE_3': 'Within 3 months',
                        'BANT_TIMELINE_6': '3-6 months',
                        'BANT_TIMELINE_12': '6-12 months',
                        'BANT_TIMELINE_RESEARCH': 'Just researching'
                    };
                    leadProfile.timeline = timelineMap[action] || value;
                    
                    // Score Timeline
                    if (action === 'BANT_TIMELINE_3') leadProfile.leadScore += 20;
                    else if (action === 'BANT_TIMELINE_6') leadProfile.leadScore += 15;
                    else if (action === 'BANT_TIMELINE_12') leadProfile.leadScore += 10;
                    else leadProfile.leadScore += 5;
                    
                    flowState = 'BANT_CAPITAL';
                    addBotMessage("Great! Do you have access to liquid capital ($150K+) needed?", [
                        { text: "Yes, ready now", action: "BANT_CAPITAL_YES" },
                        { text: "Yes, but need to arrange", action: "BANT_CAPITAL_ARRANGE" },
                        { text: "Not quite there yet", action: "BANT_CAPITAL_NO" }
                    ]);
                }
                
                // --- Step 3: Budget/Capital (Score it) ---
                else if (action === "BANT_CAPITAL_YES" || action === "BANT_CAPITAL_ARRANGE" || action === "BANT_CAPITAL_NO") {
                    const capitalMap = {
                        'BANT_CAPITAL_YES': 'Yes, ready now',
                        'BANT_CAPITAL_ARRANGE': 'Yes, but need to arrange',
                        'BANT_CAPITAL_NO': 'Not quite there yet'
                    };
                    leadProfile.capital = capitalMap[action] || value;
                    
                    // Score Capital
                    if (action === 'BANT_CAPITAL_YES') leadProfile.leadScore += 25;
                    else if (action === 'BANT_CAPITAL_ARRANGE') leadProfile.leadScore += 15;
                    else leadProfile.leadScore += 5;
                    
                    flowState = 'BANT_AUTHORITY';
                    addBotMessage("Excellent! And are you the primary decision-maker for this investment?", [
                        { text: "Just me", action: "BANT_AUTHORITY_ME" },
                        { text: "Me + partner/spouse", action: "BANT_AUTHORITY_PARTNER" },
                        { text: "Family/Business Partners", action: "BANT_AUTHORITY_FAMILY" }
                    ]);
                }
                
                // --- Step 4: Authority (Score it) ---
                else if (action === "BANT_AUTHORITY_ME" || action === "BANT_AUTHORITY_PARTNER" || action === "BANT_AUTHORITY_FAMILY") {
                    const authorityMap = {
                        'BANT_AUTHORITY_ME': 'Just me',
                        'BANT_AUTHORITY_PARTNER': 'Me + partner/spouse',
                        'BANT_AUTHORITY_FAMILY': 'Family/Business Partners'
                    };
                    leadProfile.authority = authorityMap[action] || value;
                    
                    // Score Authority
                    if (action === 'BANT_AUTHORITY_ME') leadProfile.leadScore += 20;
                    else if (action === 'BANT_AUTHORITY_PARTNER') leadProfile.leadScore += 18;
                    else leadProfile.leadScore += 15;
                    
                    flowState = 'BANT_NEED';
                    addBotMessage("Wonderful! One last question: What attracted you most to " + FRANCHISE_NAME + "? (Please type your answer)");
                }
                
                // --- Step 5: Need (Text Input, Score it) ---
                // Handled in handleInput function when flowState === 'BANT_NEED'
                
                // --- OPEN CHAT ---
                else if (action === "OPEN_CHAT") {
                    flowState = 'OPEN_CHAT';
                    addBotMessage("Great! Feel free to ask me anything about franchises. I'm here to help! üòä");
                }
                
                // --- MEETING ACTIONS ---
                else if (action === "OPEN_CALENDLY") {
                    openCalendlyWidget();
                }
                
                // --- FALLBACK: SEND TO LLM ---
                else {
                    if (flowState !== 'BANT_NEED' && flowState !== 'BANT_EXPERIENCE') {
                        sendMessageToLLM(value || action);
                    }
                }

            }, 600);
        }
        
        function checkQualificationAndSchedule() {
            console.log("Current Lead Score:", leadProfile.leadScore);
            console.log("Attraction Response:", leadProfile.attraction);

            // Calculate priority based on lead score
            let priority = 'Low';
            if (leadProfile.leadScore > 75) {
                priority = 'High';
            } else if (leadProfile.leadScore >= 60) {
                priority = 'Medium';
            }

            // Update Google Sheet if user is signed in (not guest)
            if (userProfile && userProfile.lead_id && !userProfile.lead_id.startsWith('guest_')) {
                updateLeadScore(userProfile.lead_id, leadProfile.leadScore, priority, leadProfile.attraction);
            }

            if (leadProfile.leadScore >= 60) {
                // QUALIFIED (Score >= 60)
                flowState = 'QUALIFIED';
                addBotMessage(`Perfect! ‚úÖ Based on your profile (Score: ${leadProfile.leadScore}/100), you're a great fit! Let me connect you with our team.`, [
                    { text: "üìÖ Schedule Video Call", action: "OPEN_CALENDLY" }
                ]);
            } else {
                // NURTURE (Score < 60)
                flowState = 'NURTURE';
                addBotMessage(`Thanks for your interest! Based on your current profile (Score: ${leadProfile.leadScore}/100), we'd love for you to explore our website to learn more about our franchise opportunities. Feel free to browse through our resources and information at your own pace.`, [
                    { text: "üìÖ I'd like to schedule a meeting", action: "OPEN_CALENDLY" }
                ]);
            }
        }

        // ============================================
        // UPDATE LEAD SCORE IN GOOGLE SHEETS
        // ============================================
        async function updateLeadScore(leadId, score, priority, attraction) {
            try {
                // Ensure we have a valid nonce
                if (!securityNonce) {
                    await getSecurityNonce();
                }
                
                const response = await fetch('/wp-json/pgpt/v1/lead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'UPDATE',
                        lead_id: leadId,
                        lead_score: score,
                        priority: priority,
                        attraction: attraction || '',
                        nonce: securityNonce,
                        timestamp: nonceTimestamp,
                        website: ''
                    })
                });

                if (!response.ok) {
                    console.error('Failed to update lead score');
                }

                const data = await response.json();
                console.log('Lead score updated:', data);
            } catch (error) {
                console.error('Error updating lead score:', error);
            }
        }

        // ============================================
        // TEXT INPUT HANDLER
        // ============================================
        function handleInput() {
            const text = inputField.value.trim();
            if (!chatEnabled || !text || isLoading) return;
            
            inputField.value = '';
            addUserMessage(text);

            // Handle BANT Step 5: Need (Text Input)
            if (flowState === 'BANT_NEED') {
                // Store need/attraction
                leadProfile.attraction = text; // Store attraction response
                // Score Need: +20 points for stating specific attraction
                leadProfile.leadScore += 20;
                
                // Complete qualification and check score
                flowState = 'CHECKING_SCORE';
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    checkQualificationAndSchedule();
                }, 600);
            }
            // Handle BANT Step 1: Experience (Text Input - no scoring)
            else if (flowState === 'BANT_EXPERIENCE') {
                // Store experience for context (no scoring)
                leadProfile.industry = text;
                flowState = 'BANT_TIMELINE';
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    addBotMessage("Perfect timing! What's your desired timeline for opening?", [
                        { text: "Within 3 months", action: "BANT_TIMELINE_3" },
                        { text: "3-6 months", action: "BANT_TIMELINE_6" },
                        { text: "6-12 months", action: "BANT_TIMELINE_12" },
                        { text: "Just researching", action: "BANT_TIMELINE_RESEARCH" }
                    ]);
                }, 600);
            }
            // Detect scheduling intent from natural language
            else if (flowState === 'OPEN_CHAT' || flowState === 'INIT' || flowState === 'QUALIFIED' || flowState === 'NURTURE') {
                const lowerText = text.toLowerCase();
                const schedulingKeywords = [
                    'schedule', 'scheduling', 'book', 'booking', 'appointment',
                    'call', 'meeting', 'discovery call', 'discovery meeting',
                    'talk', 'speak', 'consultation', 'demo', 'demo call'
                ];
                
                const hasSchedulingIntent = schedulingKeywords.some(keyword => lowerText.includes(keyword));
                
                if (hasSchedulingIntent) {
                    // User wants to schedule - start BANT flow
                    processFlow('BANT_START', null);
                } else {
                    // General Chat - send to LLM
                    sendMessageToLLM(text);
                }
            }
            // Default: send to LLM
            else {
                sendMessageToLLM(text);
            }
        }

        sendButton.addEventListener('click', handleInput);
        inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleInput();
            }
        });

        // ============================================
        // API CONNECTION (PrivateGPT)
        // ============================================
        async function sendMessageToLLM(text) {
            if (isLoading) return;
            
            isLoading = true;
            sendButton.disabled = true;
            showTyping();

            try {
                const messages = [];
                
                if (SYSTEM_PROMPT) {
                    messages.push({ role: 'system', content: SYSTEM_PROMPT });
                }
                
                // Attach user info to system context
                if (userProfile) {
                    messages.push({
                        role: 'system',
                        content: `User Info:\nName: ${userProfile.name}\nEmail: ${userProfile.email}\nLead ID: ${userProfile.lead_id}`
                    });
                }
                
                const recentHistory = conversationHistory.slice(-10);
                messages.push(...recentHistory);
                messages.push({ role: 'user', content: text });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: messages,
                        use_context: true,
                        include_sources: false,
                        stream: false,
                        temperature: 0.1,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                hideTyping();

                if (data.choices && data.choices[0] && data.choices[0].message) {
                    let botReply = data.choices[0].message.content || '';
                    
                    // Normalize the reply - handle null, undefined, or empty strings
                    botReply = String(botReply || '').trim();
                    
                    // Check if response is empty or indicates no information
                    const isEmpty = !botReply || botReply.length === 0 || botReply === 'Empty Response' || botReply.toLowerCase() === 'empty response';
                    const lowerMessage = botReply.toLowerCase();
                    const indicatesNoInfo = isEmpty ||
                                           lowerMessage.includes("don't have that information") || 
                                           lowerMessage.includes("not in my knowledge base") ||
                                           lowerMessage.includes("not in the context") ||
                                           lowerMessage.includes("i don't know") ||
                                           lowerMessage.includes("i cannot") ||
                                           lowerMessage.includes("i'm unable to") ||
                                           lowerMessage.includes("i don't have") ||
                                           lowerMessage.includes("no information") ||
                                           (botReply.length < 10 && botReply.length > 0); // Very short responses might indicate no info
                    
                    // Replace empty or "no info" responses with custom message
                    if (isEmpty || indicatesNoInfo) {
                        botReply = "I don't have that information in my knowledge base. For more details, please contact the Franquicia Boost team directly - you can schedule a meeting with us or drop us an email at info@franquiciaboost.com. We'd be happy to assist you further!";
                        // Show message without button
                        addBotMessage(botReply);
                    } else {
                        // Normal response - no button needed
                        addBotMessage(botReply);
                    }
                } else {
                    // If response format is unexpected, show the custom message
                    addBotMessage("I don't have that information in my knowledge base. For more details, please contact the Franquicia Boost team directly - you can schedule a meeting with us or drop us an email at info@franquiciaboost.com. We'd be happy to assist you further!", [
                        { text: "üìÖ Schedule Meeting", action: "OPEN_CALENDLY" }
                    ]);
                }

            } catch (error) {
                hideTyping();
                console.error('Error:', error);
                
                let errorMessage = 'Sorry, I encountered an error. Please try again later.';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = 'Sorry, I\'m having trouble connecting. Please check your internet connection and try again.';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = 'Sorry, there was a server error. Please try again in a moment.';
                }
                
                addBotMessage(errorMessage);
            } finally {
                isLoading = false;
                sendButton.disabled = false;
                inputField.focus();
            }
        }

        // ============================================
        // UI UTILITIES
        // ============================================
        function showTyping() {
            typingIndicator.classList.remove('pgpt-hidden');
            scrollToBottom();
        }

        function hideTyping() {
            typingIndicator.classList.add('pgpt-hidden');
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ============================================
        // CALENDLY INTEGRATION
        // ============================================
        function openCalendlyWidget() {
            if (calendlyOverlay) {
                calendlyOverlay.classList.remove('pgpt-hidden');
                
                const calendlyDiv = document.getElementById('pgpt-calendly-inline-widget');
                if (!calendlyDiv) {
                    console.error('Calendly div not found');
                    return;
                }
                
                // Load Calendly script if not already loaded
                if (!window.Calendly) {
                    const script = document.createElement('script');
                    script.src = 'https://assets.calendly.com/assets/external/widget.js';
                    script.async = true;
                    
                    script.onload = function() {
                        initializeCalendlyWidget(calendlyDiv);
                    };
                    
                    script.onerror = function() {
                        console.error('Failed to load Calendly script');
                        calendlyDiv.innerHTML = '<div style="padding: 40px; text-align: center;"><p>Unable to load Calendly widget.</p><p>Please <a href="' + CALENDLY_URL + '" target="_blank" style="color: #667eea;">click here to schedule a meeting</a>.</p></div>';
                    };
                    
                    document.body.appendChild(script);
                } else {
                    // Script already loaded, initialize immediately
                    initializeCalendlyWidget(calendlyDiv);
                }
            }
        }
        
        function initializeCalendlyWidget(calendlyDiv) {
            // Clear any previous content
            calendlyDiv.innerHTML = '';
            
            // Check if already initialized
            if (calendlyDiv.hasAttribute('data-calendly-initialized')) {
                // Already initialized, just show it
                return;
            }
            
            try {
                if (window.Calendly && window.Calendly.initInlineWidget) {
                    window.Calendly.initInlineWidget({
                        url: CALENDLY_URL,
                        parentElement: calendlyDiv
                    });
                    calendlyDiv.setAttribute('data-calendly-initialized', 'true');
                } else {
                    throw new Error('Calendly API not available');
                }
            } catch (error) {
                console.error('Error initializing Calendly:', error);
                calendlyDiv.innerHTML = '<div style="padding: 40px; text-align: center;"><p>Unable to initialize Calendly widget.</p><p>Please <a href="' + CALENDLY_URL + '" target="_blank" style="color: #667eea;">click here to schedule a meeting</a>.</p></div>';
            }
        }

        function closeCalendlyWidget() {
            if (calendlyOverlay) {
                calendlyOverlay.classList.add('pgpt-hidden');
            }
        }

        if (closeCalendlyBtn) {
            closeCalendlyBtn.addEventListener('click', closeCalendlyWidget);
        }

        if (calendlyOverlay) {
            calendlyOverlay.addEventListener('click', (e) => {
                if (e.target === calendlyOverlay) {
                    closeCalendlyWidget();
                }
            });
        }

        // ============================================
        // WHATSAPP INTEGRATION
        // ============================================
        function handleWhatsAppClick(e) {
            e.preventDefault();
            
            if (!WHATSAPP_NUMBER || WHATSAPP_NUMBER === 'YOUR_WHATSAPP_NUMBER') {
                alert('Please configure your WhatsApp number in the widget settings.');
                console.error('WhatsApp number not configured.');
                return;
            }
            
            const encodedMessage = encodeURIComponent(WHATSAPP_MESSAGE);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        }

        if (whatsappWidget) {
            whatsappWidget.addEventListener('click', handleWhatsAppClick);
        }

        // ============================================
        // DISCLAIMER BANNER
        // ============================================
        if (closeDisclaimer) {
            closeDisclaimer.addEventListener('click', () => {
                disclaimerBanner.classList.add('pgpt-hidden');
            });
        }

        // ============================================
        // PRE-CHAT CHOICE HANDLER (Guest or Sign In)
        // ============================================
        document.getElementById('pgpt-signin-btn').addEventListener('click', () => {
            // Show the form fields, hide the choice buttons completely
            const choiceScreen = document.querySelector('.pgpt-choice-buttons');
            const formFields = document.querySelector('.pgpt-form-fields');
            
            if (choiceScreen) {
                // Must use setProperty with 'important' to override CSS !important rules
                choiceScreen.style.setProperty('display', 'none', 'important');
            }
            if (formFields) {
                formFields.classList.add('active');
            }
        });

        document.getElementById('pgpt-guest-btn').addEventListener('click', () => {
            // Guest mode: Skip form, enable chat immediately
            userProfile = {
                lead_id: 'guest_' + Date.now(),
                name: 'Guest',
                email: null,
                phone: null
            };
            chatEnabled = true;

            // Enable chat input
            inputField.disabled = false;
            sendButton.disabled = false;
            inputField.placeholder = "Type your message...";
            inputField.focus();

            // Hide pre-chat form
            document.getElementById('pgpt-prechat-form').classList.add('pgpt-hidden');

            // Show welcome message for guest
            setTimeout(() => {
                addBotMessage(`Hi Guest! üëã Welcome to ${FRANCHISE_NAME}. How can I help you today?`, [
                    { text: "üìÖ Schedule Discovery Call", action: "BANT_START" },
                    { text: "üí¨ Ask Questions", action: "OPEN_CHAT" }
                ]);
            }, 500);
        });

        // ============================================
        // PRE-CHAT SIGN-IN FORM SUBMISSION
        // ============================================
        const startChatBtn = document.getElementById('pgpt-start-chat');
        let isSubmitting = false;
        
        startChatBtn.addEventListener('click', async () => {
            // Prevent multiple clicks
            if (isSubmitting) return;
            
            const name = document.getElementById('pgpt-user-name').value.trim();
            const email = document.getElementById('pgpt-user-email').value.trim();
            const phone = document.getElementById('pgpt-user-phone').value.trim();

            if (!name || !email || !phone) {
                alert('Name, email, and phone are required');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            // Disable button and show loading state
            isSubmitting = true;
            startChatBtn.disabled = true;
            startChatBtn.textContent = 'Please wait...';
            
            try {
                // Ensure we have a valid nonce
                if (!securityNonce) {
                    await getSecurityNonce();
                }
                
                // Send to WordPress REST API endpoint with security parameters
                const res = await fetch('/wp-json/pgpt/v1/lead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        operation: 'CREATE',
                        name, 
                        email, 
                        phone,
                        nonce: securityNonce,
                        timestamp: nonceTimestamp,
                        website: '' // Honeypot field (should be empty)
                    })
                });

                if (!res.ok) {
                    throw new Error('Failed to save user information');
                }

                const data = await res.json();

                userProfile = data;
                chatEnabled = true;

                // Enable chat input
                inputField.disabled = false;
                sendButton.disabled = false;
                inputField.placeholder = "Type your message...";
                inputField.focus();

                // Hide pre-chat form
                document.getElementById('pgpt-prechat-form').classList.add('pgpt-hidden');

                // Show welcome message
                setTimeout(() => {
                    addBotMessage(`Hi ${name}! üëã Welcome to ${FRANCHISE_NAME}. How can I help you today?`, [
                        { text: "üìÖ Schedule Discovery Call", action: "BANT_START" },
                        { text: "üí¨ Ask Questions", action: "OPEN_CHAT" }
                    ]);
                }, 500);

            } catch (error) {
                console.error('Error saving user info:', error);
                // Re-enable button on error
                isSubmitting = false;
                startChatBtn.disabled = false;
                startChatBtn.textContent = 'Start Chat';
                
                // For development/testing: proceed anyway but warn user
                if (confirm('Unable to connect to server. Would you like to continue anyway?')) {
                    userProfile = {
                        lead_id: 'local_' + Date.now(),
                        name: name,
                        email: email,
                        phone: phone
                    };
                    chatEnabled = true;
                    
                    // Enable chat input
                    inputField.disabled = false;
                    sendButton.disabled = false;
                    inputField.placeholder = "Type your message...";
                    inputField.focus();
                    
                    document.getElementById('pgpt-prechat-form').classList.add('pgpt-hidden');
                    setTimeout(() => {
                        addBotMessage(`Hi ${name}! üëã Welcome to ${FRANCHISE_NAME}. How can I help you today?`, [
                            { text: "üìÖ Schedule Discovery Call", action: "BANT_START" },
                            { text: "üí¨ Ask Questions", action: "OPEN_CHAT" }
                        ]);
                    }, 500);
                }
            }
        });

        // Allow Enter key to submit pre-chat form
        ['pgpt-user-name', 'pgpt-user-email', 'pgpt-user-phone'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('pgpt-start-chat').click();
                    }
                });
            }
        });

        // ============================================
        // CHAT BUBBLE & TOGGLE HANDLERS
        // ============================================
        const chatBubble = document.getElementById('pgpt-chat-bubble');
        const chatbotContainer = document.getElementById('pgpt-chatbot-container');
        const feedbackOverlay = document.getElementById('pgpt-feedback-overlay');

        function handleChatbotClose() {
            // Show feedback if user is signed in (not guest) and has chatted
            if (userProfile && !userProfile.lead_id.startsWith('guest_') && conversationHistory.length > 0) {
                showFeedbackPrompt();
            } else {
                // Collapse to bubble immediately
                collapseToBubble();
            }
        }

        function collapseToBubble() {
            if (chatbotContainer) {
                chatbotContainer.classList.add('pgpt-collapsed');
            }
            if (chatBubble) {
                chatBubble.classList.remove('pgpt-hidden');
            }
        }

        function showFeedbackPrompt() {
            if (feedbackOverlay) {
                feedbackOverlay.classList.remove('pgpt-hidden');
            }
        }

        function hideFeedbackPrompt() {
            if (feedbackOverlay) {
                feedbackOverlay.classList.add('pgpt-hidden');
            }
        }

        // ============================================
        // FEEDBACK HANDLERS
        // ============================================
        const feedbackButtons = document.querySelectorAll('.pgpt-feedback-btn');
        feedbackButtons.forEach(btn => {
            btn.addEventListener('click', async () => {
                const feedback = btn.dataset.feedback; // "Good" or "Bad"
                
                // Save feedback to Google Sheet
                if (userProfile && userProfile.lead_id) {
                    await updateFeedback(userProfile.lead_id, feedback);
                }
                
                // Clear chat messages
                const messages = chatContainer.querySelectorAll('.pgpt-message');
                messages.forEach(msg => msg.remove());
                
                // Reset conversation history
                conversationHistory = [];
                
                // Hide feedback overlay and collapse to bubble
                hideFeedbackPrompt();
                collapseToBubble();
            });
        });

        async function updateFeedback(leadId, feedback) {
            try {
                // Ensure we have a valid nonce
                if (!securityNonce) {
                    await getSecurityNonce();
                }
                
                const response = await fetch('/wp-json/pgpt/v1/lead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'UPDATE',
                        lead_id: leadId,
                        feedback: feedback,
                        nonce: securityNonce,
                        timestamp: nonceTimestamp,
                        website: '' // Honeypot field
                    })
                });

                if (!response.ok) {
                    console.error('Failed to update feedback');
                }

                const data = await response.json();
                console.log('Feedback updated:', data);
            } catch (error) {
                console.error('Error updating feedback:', error);
            }
        }

        function handleChatbotOpen() {
            // Expand from bubble
            if (chatbotContainer) {
                chatbotContainer.classList.remove('pgpt-collapsed');
            }
            if (chatBubble) {
                chatBubble.classList.add('pgpt-hidden');
            }
        }

        // Event listeners
        if (closeChatbotBtn) {
            closeChatbotBtn.addEventListener('click', handleChatbotClose);
        }

        if (chatBubble) {
            chatBubble.addEventListener('click', handleChatbotOpen);
        }

    })();
    </script>
</body>
</html>
